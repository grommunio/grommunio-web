Ext.namespace("Zarafa.plugins.files.backend.Default.data.singleton"),Zarafa.plugins.files.backend.Default.data.singleton.ShareStore=Ext.extend(Object,{store:void 0,init:function(e){this.store=new Zarafa.plugins.files.backend.Default.data.ShareGridStore(e)},addUser:function(e){var a=!1,t=!1,i=!1,s=!1;e.permissions-16>=1&&(s=!0,e.permissions-=16),e.permissions-8>=1&&(i=!0,e.permissions-=8),e.permissions-4>=1&&(a=!0,e.permissions-=4),e.permissions-2>=1&&(t=!0);var r=[e.id,e.shareWith,e.shareWithDisplayname,"user",a,t,i,s];this.store.loadData([r],!0)},addGroup:function(e){var a=!1,t=!1,i=!1,s=!1;e.permissions-16>=1&&(s=!0,e.permissions-=16),e.permissions-8>=1&&(i=!0,e.permissions-=8),e.permissions-4>=1&&(a=!0,e.permissions-=4),e.permissions-2>=1&&(t=!0);var r=[e.id,e.shareWith,e.shareWithDisplayname,"group",a,t,i,s];this.store.loadData([r],!0)},getStore:function(){return this.store}}),Zarafa.plugins.files.backend.Default.data.singleton.ShareStore=new Zarafa.plugins.files.backend.Default.data.singleton.ShareStore,Ext.namespace("Zarafa.plugins.files.backend.Default.data"),Zarafa.plugins.files.backend.Default.data.ShareGridStore=Ext.extend(Ext.data.ArrayStore,{constructor:function(e){Zarafa.plugins.files.backend.Default.data.ShareGridStore.superclass.constructor.call(this,{fields:["id","shareWith","shareWithDisplayname","type","permissionCreate","permissionChange","permissionDelete","permissionShare"],fileType:e})}}),Ext.reg("filesplugin.default.sharegridstore",Zarafa.plugins.files.backend.Default.data.ShareGridStore),Ext.namespace("Zarafa.plugins.files.backend.Default.data"),Zarafa.plugins.files.backend.Default.data.RecipientTypes=Zarafa.core.Enum.create({USER:0,GROUP:1,LINK:3}),Ext.namespace("Zarafa.plugins.files.backend.Default.data"),Zarafa.plugins.files.backend.Default.data.ResponseHandler=Ext.extend(Zarafa.core.data.AbstractResponseHandler,{successCallback:null,failureCallback:null,doLoadsharingdetails:function(e){this.successCallback(e)},doCreatenewshare:function(e){this.successCallback(e)},doDeleteexistingshare:function(e){this.successCallback(e)},doUpdateexistingshare:function(e){this.successCallback(e)},doError:function(e){Zarafa.common.dialogs.MessageBox.show({title:e.header,msg:e.message,icon:Zarafa.common.dialogs.MessageBox.ERROR,buttons:Zarafa.common.dialogs.MessageBox.OK}),this.failureCallback(e)}}),Ext.reg("filesplugin.default.responsehandler",Zarafa.plugins.files.backend.Default.data.ResponseHandler),Ext.namespace("Zarafa.plugins.files.backend.Default.data"),Zarafa.plugins.files.backend.Default.data.ShareGridRecord=Ext.data.Record.create({name:"id",type:"string"},{name:"shareWith",type:"string"},{name:"shareWithDisplayname",type:"string"},{name:"type",type:"string"},{name:"permissionCreate",type:"bool"},{name:"permissionChange",type:"bool"},{name:"permissionDelete",type:"bool"},{name:"permissionShare",type:"bool"}),Ext.namespace("Zarafa.plugins.files.backend.Default"),Zarafa.plugins.files.backend.Default.DefaultBackend=Ext.extend(Zarafa.core.Plugin,{constructor:function(e){e=e||{},Zarafa.plugins.files.backend.Default.DefaultBackend.superclass.constructor.call(this,e)},initPlugin:function(){Zarafa.plugins.files.backend.Default.DefaultBackend.superclass.initPlugin.apply(this,arguments),this.registerInsertionPoint("plugin.files.sharedialog",this.createShareDialogInsertionPoint,this),Zarafa.core.data.SharedComponentType.addProperty("filesplugin.default.useredit")},createShareDialogInsertionPoint:function(){return{xtype:"filesplugin.default.filessharedialogpanel"}},bidSharedComponent:function(e,a){var t=-1;if(e===Zarafa.core.data.SharedComponentType["filesplugin.default.useredit"])t=1;return t},getSharedComponent:function(e,a){var t;if(e===Zarafa.core.data.SharedComponentType["filesplugin.default.useredit"])t=Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditContentPanel;return t}}),Zarafa.onReady((function(){container.registerPlugin(new Zarafa.core.PluginMetaData({name:"filesbackendDefault",displayName:_("Files: Default plugin"),allowUserDisable:!1,pluginConstructor:Zarafa.plugins.files.backend.Default.DefaultBackend}))})),Ext.namespace("Zarafa.plugins.files.backend.Default.ui"),Zarafa.plugins.files.backend.Default.ui.FilesShareUserGrid=Ext.extend(Ext.grid.GridPanel,{store:void 0,recordId:void 0,constructor:function(e){e=e||{},this.store=Zarafa.plugins.files.backend.Default.data.singleton.ShareStore.getStore(),Ext.applyIf(e,{xtype:"filesplugin.default.filesshareusergrid",ref:"sharegrid",store:this.store,border:!1,baseCls:"shareGrid",enableHdMenu:!1,loadMask:this.initLoadMask(),viewConfig:this.initViewConfig(),sm:this.initSelectionModel(),cm:this.initColumnModel(),listeners:{rowdblclick:this.onRowDblClick,scope:this},tbar:[{iconCls:"filesplugin_icon_add",text:_("Add"),handler:this.onAdd.createDelegate(this)},"-",{iconCls:"filesplugin_icon_delete",text:_("Delete"),ref:"../removeAccountBtn",disabled:!0,handler:this.onDelete.createDelegate(this)}]}),Zarafa.plugins.files.backend.Default.ui.FilesShareUserGrid.superclass.constructor.call(this,e)},initLoadMask:function(){return{msg:_("Loading users and groups")+"..."}},initViewConfig:function(){return{enableRowBody:!1,forceFit:!0,emptyText:"<div class='emptytext'>"+_("Add users or groups to share files.")+"</div>",deferEmptyText:!1}},initSelectionModel:function(){return new Ext.grid.RowSelectionModel({singleSelect:!0,listeners:{selectionchange:this.onRowSelected}})},initColumnModel:function(){return new Zarafa.plugins.files.backend.Default.ui.FilesShareUserGridColumnModel({fileType:this.store.fileType})},onRowSelected:function(e){this.grid.removeAccountBtn.setDisabled(1!=e.getCount())},onRowDblClick:function(e,a){Zarafa.core.data.UIFactory.openLayerComponent(Zarafa.core.data.SharedComponentType["filesplugin.default.useredit"],void 0,{store:e.getStore(),record:e.getStore().getAt(a),manager:Ext.WindowMgr,recordId:this.recordId})},onAdd:function(e,a){Zarafa.core.data.UIFactory.openLayerComponent(Zarafa.core.data.SharedComponentType["filesplugin.default.useredit"],void 0,{store:this.store,manager:Ext.WindowMgr,recordId:this.recordId})},onDelete:function(e,a){var t=this.getSelectionModel().getSelected();if(!t)return!1;this.store.remove(t)}}),Ext.reg("filesplugin.default.filesshareusergrid",Zarafa.plugins.files.backend.Default.ui.FilesShareUserGrid),Ext.namespace("Zarafa.plugins.files.backend.Default.ui"),Zarafa.plugins.files.backend.Default.ui.FilesShareUserGridColumnModel=Ext.extend(Zarafa.common.ui.grid.ColumnModel,{constructor:function(e){e=e||{},this.defaultColumns=this.createDefaultColumns(e.fileType),Ext.applyIf(e,{columns:this.defaultColumns,defaults:{sortable:!0}}),Ext.apply(this,e),Zarafa.plugins.files.backend.Default.ui.FilesShareUserGridColumnModel.superclass.constructor.call(this,e)},createDefaultColumns:function(e){var a=[{header:_("Name"),dataIndex:"shareWithDisplayname",flex:1,sortable:!0,tooltip:_("Sort by: Name")},{header:_("Type"),dataIndex:"type",flex:1,align:"center",sortable:!0,renderer:this.shareTypeRenderer,tooltip:_("Sort by: Type")},{header:_("Re-share"),dataIndex:"permissionShare",flex:1,align:"center",sortable:!1,renderer:this.yesNoRenderer},{header:_("Change"),dataIndex:"permissionChange",flex:1,align:"center",sortable:!1,renderer:this.yesNoRenderer}];return e===Zarafa.plugins.files.data.FileTypes.FOLDER&&a.push({header:_("Create"),dataIndex:"permissionCreate",flex:1,align:"center",sortable:!1,renderer:this.yesNoRenderer},{header:_("Delete"),dataIndex:"permissionDelete",flex:1,align:"center",sortable:!1,renderer:this.yesNoRenderer}),a},shareTypeRenderer:function(e,a,t){return a.css="shareicon_16_"+e,a.css+=" zarafa-grid-empty-cell",""},yesNoRenderer:function(e,a,t){return a.css=e?"shareicon_16_yes":"shareicon_16_no",a.css+=" zarafa-grid-empty-cell",""}}),Ext.namespace("Zarafa.plugins.files.backend.Default.ui"),Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditPanel=Ext.extend(Ext.form.FormPanel,{record:void 0,store:void 0,recordId:void 0,constructor:function(e){e.record&&(this.record=e.record),e.store&&(this.store=e.store),e.recordId&&(this.recordId=e.recordId),Ext.applyIf(e||{},{labelAlign:"left",defaultType:"textfield",items:this.createPanelItems(),buttons:[{text:_("Save"),handler:this.doSave,scope:this},{text:_("Cancel"),handler:this.doClose,scope:this}]}),Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditPanel.superclass.constructor.call(this,e)},doClose:function(){this.ownerCt.dialog.close()},doSave:function(){var e=this.shareWith.getStore().getAt(this.shareWith.selectedIndex);if(this.record)this.record.beginEdit(),e&&(this.record.set("type",this.type.getValue()),this.record.set("shareWith",e.data.shareWith),this.record.set("shareWithDisplayname",e.data.display_name)),this.record.set("permissionShare",this.permissionShare.getValue()),this.record.set("permissionChange",this.permissionChange.getValue()),this.record.set("permissionCreate",this.store.fileType===Zarafa.plugins.files.data.FileTypes.FOLDER&&this.permissionCreate.getValue()),this.record.set("permissionDelete",this.store.fileType===Zarafa.plugins.files.data.FileTypes.FOLDER&&this.permissionDelete.getValue()),this.record.endEdit();else{var a=new this.store.recordType({id:-1,type:this.type.getValue(),shareWith:e.data.shareWith,shareWithDisplayname:e.data.display_name,permissionCreate:this.store.fileType===Zarafa.plugins.files.data.FileTypes.FOLDER&&this.permissionCreate.getValue(),permissionChange:this.permissionChange.getValue(),permissionDelete:this.store.fileType===Zarafa.plugins.files.data.FileTypes.FOLDER&&this.permissionDelete.getValue(),permissionShare:this.permissionShare.getValue()});this.store.add(a)}this.ownerCt.dialog.close()},createPanelItems:function(){var e="user",a="",t=!1,i=!1,s=!1,r=!1;this.record&&(e=this.record.get("type"),this.record.get("shareWith"),a=this.record.get("shareWithDisplayname"),r=this.record.get("permissionShare"),i=this.record.get("permissionChange"),this.store.fileType===Zarafa.plugins.files.data.FileTypes.FOLDER&&(t=this.record.get("permissionCreate"),s=this.record.get("permissionDelete")));var n=[{xtype:"checkbox",fieldLabel:_("Re-share"),name:"permissionShare",ref:"../permissionShare",checked:r},{xtype:"checkbox",fieldLabel:_("Change"),name:"permissionChange",ref:"../permissionChange",checked:i}];return this.store.fileType===Zarafa.plugins.files.data.FileTypes.FOLDER&&n.push({xtype:"checkbox",fieldLabel:_("Create"),name:"permissionCreate",ref:"../permissionCreate",checked:t},{xtype:"checkbox",fieldLabel:_("Delete"),name:"permissionDelete",ref:"../permissionDelete",checked:s}),[{xtype:"filesplugin.default.usergrouppredictorfield",fieldLabel:_("Share with"),name:"shareWith",ref:"shareWith",allowBlank:!1,value:a,recordId:this.recordId},{xtype:"selectbox",fieldLabel:_("Type"),name:"type",ref:"type",allowBlank:!1,value:e,store:[["user","User"],["group","Group"]],mode:"local"},{xtype:"fieldset",title:_("Permissions"),defaults:{labelWidth:89,anchor:"100%",xtype:"textfield"},items:n}]}}),Ext.reg("filesplugin.default.filesshareusereditpanel",Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditPanel),Ext.namespace("Zarafa.plugins.files.backend.Default.ui"),Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditContentPanel=Ext.extend(Zarafa.core.ui.ContentPanel,{loadMask:void 0,constructor:function(e){Ext.applyIf(e,{layout:"fit",title:_("Share Details"),closeOnSave:!0,model:!0,autoSave:!1,width:550,height:445,items:{xtype:"filesplugin.default.filesshareusereditpanel",record:e.record,store:e.store,recordId:e.recordId}}),Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditContentPanel.superclass.constructor.call(this,e)}}),Ext.reg("filesplugin.default.filesshareusereditcontentpanel",Zarafa.plugins.files.backend.Default.ui.FilesShareUserEditContentPanel),Ext.namespace("Zarafa.plugins.files.backend.Default.ui"),Zarafa.plugins.files.backend.Default.ui.UserGroupPredictorField=Ext.extend(Ext.form.ComboBox,{constructor:function(e){var a=new Ext.data.ArrayStore({proxy:new Ext.data.HttpProxy({method:"GET",url:container.getBasePath()+"index.php"}),method:"GET",baseParams:{load:"custom",name:"files_get_recipients",id:e.recordId},id:1,fields:["display_name","shareWith","object_type"]});e=e||{},Ext.applyIf(e,{store:a,displayField:"display_name",typeAhead:!1,forceSelection:!0,triggerAction:"query",itemId:"predictor",mode:"remote",minChars:2,emptyText:_("Type to search"),loadingText:_("Loading…"),listEmptyText:_("No results"),itemSelector:"div.ugpredic_search_item",tpl:new Ext.XTemplate('<tpl for=".">','<div class="ugpredic_search_item">',"<h3>",'<tpl if="object_type == Zarafa.plugins.files.backend.Default.data.RecipientTypes.USER"><span><div class="shareicon_16_user">&nbsp;</div></span></tpl>','<tpl if="object_type == Zarafa.plugins.files.backend.Default.data.RecipientTypes.GROUP"><span><div class="shareicon_16_group">&nbsp;</div></span></tpl>',"{display_name:htmlEncode}","</h3>","</div>","</tpl>","</tpl>"),onSelect:this.onSuggestionSelect,listeners:{invalid:this.onInvalid,scope:this}}),Zarafa.plugins.files.backend.Default.ui.UserGroupPredictorField.superclass.constructor.call(this,e)},onSuggestionSelect:function(e){this.setRawValue(e.get("display_name")),this.ownerCt.type.setValue(e.get("object_type")==Zarafa.plugins.files.backend.Default.data.RecipientTypes.USER?"user":"group"),this.collapse()},onInvalid:function(){this.isExpanded()&&(this.store.removeAll(),this.collapse())}}),Ext.reg("filesplugin.default.usergrouppredictorfield",Zarafa.plugins.files.backend.Default.ui.UserGroupPredictorField),Ext.namespace("Zarafa.plugins.files.backend.Default.ui"),Zarafa.plugins.files.backend.Default.ui.FilesShareDialogPanel=Ext.extend(Zarafa.plugins.files.ui.dialogs.SharePanel,{loadMask:void 0,passwordChanged:!1,expirationDateChanged:!1,pubUploadChanged:!1,linkShareID:-1,recordId:void 0,parentRecord:void 0,constructor:function(e){var a=(e=e||{}).ownerCt.records[0].get("type");this.recordId=e.ownerCt.records[0].get("folder_id"),this.parentRecord=e.ownerCt.records[0];var t=this.parentRecord.get("sharedid");Zarafa.plugins.files.backend.Default.data.singleton.ShareStore.init(a),this.setupGridStoreListeners(),Ext.applyIf(e,{listeners:{afterrender:this.checkSharedRecord},height:450,width:780,items:[{xtype:"fieldset",title:_("Share with user/group"),autoHeight:!0,ref:"userfieldset",items:[{xtype:"filesplugin.default.filesshareusergrid",ref:"../usergrid",height:200,recordId:this.recordId}]},{xtype:"checkbox",fieldLabel:"",boxLabel:_("Share via link"),ref:"linkcheckbox",inputValue:"sharelink",style:{marginTop:"5px",marginLeft:"6px"},listeners:{check:this.onShareViaLinkChecked.createDelegate(this)}},{xtype:"fieldset",title:_("Share via link"),autoHeight:!0,ref:"linkfieldset",hidden:!0,items:[{layout:"column",border:!1,defaults:{border:!1},anchor:"0",items:[{columnWidth:.95,layout:"form",items:{xtype:"textfield",fieldLabel:_("Public link"),ref:"../../../linkfield",anchor:"100%",selectOnFocus:!0,readOnly:!0}},{columnWidth:.05,items:{xtype:"button",iconCls:"icon_copy_clipboard",handler:this.onCopyUrl,scope:this}}]},{xtype:"checkbox",fieldLabel:_("Password protect"),boxLabel:"",ref:"../passwordcheckbox",inputValue:"pwprotected",listeners:{check:this.onUsePasswordChecked.createDelegate(this)}},{xtype:"textfield",fieldLabel:_("Password"),ref:"../passwordfield",hidden:!0,inputType:"password",name:"textvalue",listeners:{change:this.onPasswordChange.createDelegate(this),keyup:this.onPasswordChange.createDelegate(this)}},{xtype:"checkbox",fieldLabel:_("Public upload"),boxLabel:"",hidden:!0,ref:"../editcheckbox",inputValue:"allowediting",listeners:{check:this.onAllowEditingChecked.createDelegate(this)}},{xtype:"checkbox",fieldLabel:_("Expiration date"),boxLabel:"",ref:"../expirationcheckbox",inputValue:"useexpiration",listeners:{check:this.onUseExpirationDateChecked.createDelegate(this)}},{xtype:"datefield",ref:"../expirationfield",hidden:!0,fieldLabel:_("Date"),minValue:new Date((new Date).getTime()+864e5),width:170,format:"Y-m-d",listeners:{change:this.onExpirationDateChange.createDelegate(this),keyup:this.onExpirationDateChange.createDelegate(this)}}]},{xtype:"label",text:_("More than 1 share link exists. Only showing the latest one"),hidden:(t||[]).length<2,width:"100%",autoWidth:!0}],buttons:[{xtype:"button",text:_("Ok"),handler:this.onDoneButtonClick,ref:"../doneButton",scope:this},{xtype:"button",text:_("Cancel"),handler:this.onCancel,scope:this}]}),Zarafa.plugins.files.backend.Default.ui.FilesShareDialogPanel.superclass.constructor.call(this,e)},setupGridStoreListeners:function(){var e=Zarafa.plugins.files.backend.Default.data.singleton.ShareStore.getStore();e.on("add",this.onGridStoreAdd,this),e.on("update",this.onGridStoreUpdate,this),e.on("remove",this.onGridStoreRemove,this)},onGridStoreRemove:function(e,a){""!=a.get("id")&&-1!=a.get("id")&&this.removeShareByID(a.get("id"))},onGridStoreUpdate:function(e,a){this.updateExistingShare(a)},onGridStoreAdd:function(e,a){if(1!=a.length||-1!=a[0].get("id"))return!0;this.createShare(a[0],e,!1)},onShareViaLinkChecked:function(e,a){a?(this.linkfieldset.show(),this.createShareByLink()):(this.linkfieldset.hide(),this.removeShareByID(this.linkShareID),this.linkShareID=-1)},onUsePasswordChecked:function(e,a){a?this.passwordfield.show():this.passwordfield.hide()},onPasswordChange:function(e,a){this.passwordChanged=!0},onAllowEditingChecked:function(e,a){this.pubUploadChanged=!0},onUseExpirationDateChecked:function(e,a){a?this.expirationfield.show():this.expirationfield.hide()},onExpirationDateChange:function(){this.expirationDateChanged=!0},onCancel:function(){this.dialog.close()},closeDialog:function(){var e=Zarafa.plugins.files.backend.Default.data.singleton.ShareStore.getStore();e.un("update",this.onGridStoreUpdate,this),e.un("remove",this.onGridStoreRemove,this),this.dialog.close()},closeLoadMask:function(){this.loadMask.hide()},onDoneButtonClick:function(){this.linkcheckbox.getValue()?(this.updateExistingShare(),Zarafa.plugins.files.data.Actions.updateCache(this.recordId)):this.closeDialog()},onCopyUrl:function(){this.linkfield.el.dom.select(),document.execCommand("copy")},checkSharedRecord:function(){this.loadMask=new Ext.LoadMask(this.getEl(),{msg:_("Loading details…")}),Ext.isDefined(this.parentRecord)&&(this.parentRecord.get("type")===Zarafa.plugins.files.data.FileTypes.FOLDER&&this.editcheckbox.show(),!0===this.parentRecord.get("isshared")&&this.initSharedRecord())},initSharedRecord:function(){this.loadMask.show();var e=[this.recordId];container.getRequest().singleRequest("filesbrowsermodule","loadsharingdetails",{records:e},new Zarafa.plugins.files.backend.Default.data.ResponseHandler({successCallback:this.initGuiFromSharedRecord.createDelegate(this)}))},initGuiFromSharedRecord:function(e){var a=e.shares[this.recordId];for(var t in a){var i=a[t];if(i.shareType===Zarafa.plugins.files.backend.Default.data.RecipientTypes.LINK){if(this.linkShareID=t,this.linkfieldset.show(),this.linkcheckbox.suspendEvents(!1),this.linkcheckbox.setValue(!0),this.linkcheckbox.resumeEvents(),this.linkfield.setValue(i.url),!Ext.isEmpty(i.expiration)){this.expirationcheckbox.setValue(!0);var s=new Date(i.expiration);this.expirationfield.setValue(s)}Ext.isEmpty(i.shareWith)||(this.passwordcheckbox.setValue(!0),this.passwordfield.setValue("******")),Ext.isEmpty(i.permissions)||7===parseInt(i.permissions)&&(this.editcheckbox.suspendEvents(!1),this.editcheckbox.setValue(!0),this.editcheckbox.resumeEvents())}else i.shareType===Zarafa.plugins.files.backend.Default.data.RecipientTypes.GROUP?Zarafa.plugins.files.backend.Default.data.singleton.ShareStore.addGroup(i):Zarafa.plugins.files.backend.Default.data.singleton.ShareStore.addUser(i);this.doneButton.setDisabled(!1)}this.loadMask.hide()},createShareByLink:function(){this.loadMask.show();var e=[this.recordId],a={shareType:Zarafa.plugins.files.backend.Default.data.RecipientTypes.LINK};container.getRequest().singleRequest("filesbrowsermodule","createnewshare",{records:e,options:a},new Zarafa.plugins.files.backend.Default.data.ResponseHandler({successCallback:this.shareByLinkCreated.createDelegate(this),failureCallback:this.closeDialog.createDelegate(this)}))},shareByLinkCreated:function(e){var a=e.shares[this.recordId.replace(/\/+$/g,"")];this.linkfield.setValue(a.url),this.linkShareID=a.id;var t=this.parentRecord.get("sharedid")||[];t.push(a.id),this.parentRecord.set("sharedid",t),this.parentRecord.set("isshared",!0),this.doneButton.setDisabled(!1),Zarafa.plugins.files.data.Actions.updateCache(this.recordId),this.loadMask.hide()},removeShareByID:function(e){this.loadMask.show();var a=this.parentRecord.getAccount().get("id");container.getRequest().singleRequest("filesbrowsermodule","deleteexistingshare",{records:[e],accountid:a},new Zarafa.plugins.files.backend.Default.data.ResponseHandler({successCallback:this.shareByIDRemoved.createDelegate(this,[e],!0),failureCallback:this.closeDialog.createDelegate(this)}))},shareByIDRemoved:function(e,a){var t=this.parentRecord.get("sharedid")||[],i=t.indexOf(parseInt(a));i>-1&&t.splice(i,1),this.parentRecord.set("sharedid",t),0==t.length&&this.parentRecord.set("isshared",!1),Zarafa.plugins.files.data.Actions.updateCache(this.recordId),this.loadMask.hide()},createShare:function(e,a){this.loadMask.show();var t=[this.recordId],i=this.getPermissions(e),s={shareType:"user"===e.get("type")?Zarafa.plugins.files.backend.Default.data.RecipientTypes.USER:Zarafa.plugins.files.backend.Default.data.RecipientTypes.GROUP,shareWith:e.get("shareWith"),permissions:i,shareWithDisplayname:e.get("shareWithDisplayname")};container.getRequest().singleRequest("filesbrowsermodule","createnewshare",{records:t,options:s},new Zarafa.plugins.files.backend.Default.data.ResponseHandler({successCallback:this.shareCreated.createDelegate(this,[s,e],!0),failureCallback:this.shareFailed.createDelegate(this,[a,e])}))},shareCreated:function(e,a,t){var i=e.shares[this.recordId.replace(/\/+$/g,"")],s=this.parentRecord.get("sharedid")||[];s.push(i.id),t.data.id=i.id,this.parentRecord.set("sharedid",s),this.parentRecord.set("isshared",!0),a.id=i.id,this.loadMask.hide()},shareFailed:function(e,a){e.remove(a),this.loadMask.hide()},updateExistingShare:function(e){this.loadMask.show();var a={},t=[];Ext.isDefined(e)?(a.permissions=this.getPermissions(e),t.push(e.get("id"))):(this.passwordChanged&&(a.password=this.passwordfield.getValue()),this.passwordcheckbox.getValue()||(a.password=""),this.pubUploadChanged&&(this.editcheckbox.getValue()?a.permissions=7:a.permissions=1),this.expirationDateChanged&&(a.expireDate=this.expirationfield.getRawValue()),this.expirationcheckbox.getValue()||(a.expireDate=""),t.push(this.linkShareID)),container.getRequest().singleRequest("filesbrowsermodule","updateexistingshare",{records:t,accountid:this.parentRecord.getAccount().get("id"),options:a},new Zarafa.plugins.files.backend.Default.data.ResponseHandler({successCallback:this.shareByLinkUpdated.createDelegate(this,[e]),failureCallback:this.closeLoadMask.createDelegate(this)}))},shareByLinkUpdated:function(e){this.loadMask.hide(),Ext.isDefined(e)||this.closeDialog()},getPermissions:function(e){var a=1;return e.get("permissionChange")&&(a+=2),e.get("permissionCreate")&&(a+=4),e.get("permissionDelete")&&(a+=8),e.get("permissionShare")&&(a+=16),a}}),Ext.reg("filesplugin.default.filessharedialogpanel",Zarafa.plugins.files.backend.Default.ui.FilesShareDialogPanel);